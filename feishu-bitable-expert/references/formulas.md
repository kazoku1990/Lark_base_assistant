# 公式与函数参考

## 目录
- [概览](#概览)
- [公式基础](#公式基础)
- [常用函数分类](#常用函数分类)
- [常见公式模式](#常见公式模式)
- [复杂公式案例](#复杂公式案例)
- [公式调试技巧](#公式调试技巧)

## 概览
飞书多维表格公式字段支持丰富的函数库，可以进行数值计算、文本处理、日期时间操作、逻辑判断等。熟练掌握公式可以大幅提升数据处理的自动化程度。

## 公式基础

### 公式语法
- 使用等号 `=` 开始
- 支持引用其他字段：`{字段名}`
- 支持嵌套函数：`函数1(函数2(参数))`
- 支持运算符：`+` `-` `*` `/` `^` `&`

### 字段引用
- 直接引用：`{单价} * {数量}`
- 关联表字段：`{关联表.字段名}`
- 查找引用：`{查找引用字段}`

### 运算符优先级
1. 括号 `()`
2. 函数
3. 指数 `^`
4. 乘除 `*` `/`
5. 加减 `+` `-`
6. 连接 `&`
7. 比较运算符 `=` `<>` `<` `>` `<=` `>=`

## 常用函数分类

### 数值函数

#### SUM - 求和
```
SUM(数值1, 数值2, ...)
SUM(字段1, 字段2, ...)
```
**示例**：
- `SUM({单价}, {数量})` - 单价+数量
- `SUM({销售额})` - 销售额字段的总和（在汇总字段中使用）

#### AVERAGE - 平均值
```
AVERAGE(数值1, 数值2, ...)
AVERAGE(字段1, 字段2, ...)
```
**示例**：
- `AVERAGE({语文}, {数学}, {英语})` - 计算三科平均分

#### ROUND - 四舍五入
```
ROUND(数值, 位数)
```
**示例**：
- `ROUND(3.14159, 2)` → 3.14
- `ROUND({总金额}, 0)` - 总金额取整

#### MAX / MIN - 最大值/最小值
```
MAX(数值1, 数值2, ...)
MIN(数值1, 数值2, ...)
```
**示例**：
- `MAX({价格}, {预算})` - 取价格和预算中的较大值

### 文本函数

#### LEN - 文本长度
```
LEN(文本)
```
**示例**：
- `LEN({商品名称})` - 计算商品名称的字符数

#### LEFT / RIGHT / MID - 截取文本
```
LEFT(文本, 字符数)
RIGHT(文本, 字符数)
MID(文本, 起始位置, 字符数)
```
**示例**：
- `LEFT({手机号}, 3)` - 取手机号前3位
- `RIGHT({身份证号}, 4)` - 取身份证号后4位
- `MID({学号}, 3, 2)` - 从第3位开始取2个字符

#### FIND - 查找文本位置
```
FIND(要查找的文本, 在哪里查找, [起始位置])
```
**示例**：
- `FIND("@", {邮箱})` - 查找@在邮箱中的位置

#### SUBSTITUTE - 替换文本
```
SUBSTITUTE(文本, 旧文本, 新文本, [替换第几个])
```
**示例**：
- `SUBSTITUTE({电话}, "-", "")` - 移除电话号码中的横线

#### CONCATENATE / & - 连接文本
```
CONCATENATE(文本1, 文本2, ...)
文本1 & 文本2 & ...
```
**示例**：
- `CONCATENATE({姓}, {名})` - 姓名拼接
- `{省份} & {城市}` - 省市拼接

#### LOWER / UPPER - 大小写转换
```
LOWER(文本)
UPPER(文本)
```
**示例**：
- `LOWER({邮箱})` - 邮箱转小写

#### TRIM - 去除空格
```
TRIM(文本)
```
**示例**：
- `TRIM({名称})` - 去除名称首尾空格

### 日期时间函数

#### NOW / TODAY - 当前时间/日期
```
NOW()
TODAY()
```
**示例**：
- `TODAY()` - 当前日期
- `NOW()` - 当前日期和时间

#### DATEDIF - 日期差
```
DATEDIF(开始日期, 结束日期, 单位)
```
单位：`Y`=年, `M`=月, `D`=日

**示例**：
- `DATEDIF({入职日期}, TODAY(), "Y")` - 计算工作年限
- `DATEDIF({开始日期}, {结束日期}, "D")` - 计算天数

#### DATEADD - 日期加减
```
DATEADD(日期, 数量, 单位)
```
单位：`D`=日, `M`=月, `Y`=年

**示例**：
- `DATEADD({开始日期}, 7, "D")` - 开始日期后7天
- `DATEADD(TODAY(), 1, "M")` - 下个月今天

#### DATETIME_DIFF - 日期时间差
```
DATETIME_DIFF(日期时间1, 日期时间2, 单位)
```
**示例**：
- `DATETIME_DIFF({截止时间}, NOW(), "H")` - 距离截止时间的小时数

#### WORKDAY - 工作日计算
```
WORKDAY(开始日期, 工作日数, [节假日])
```
**示例**：
- `WORKDAY({提交日期}, 5)` - 提交日期后5个工作日

#### EOMONTH - 月末日期
```
EOMONTH(日期, [月数])
```
**示例**：
- `EOMONTH(TODAY(), 0)` - 本月最后一天
- `EOMONTH(TODAY(), 1)` - 下月最后一天

### 逻辑函数

#### IF - 条件判断
```
IF(条件, 值为真, 值为假)
```
**示例**：
- `IF({成绩} >= 60, "及格", "不及格")` - 成绩是否及格
- `IF({状态} = "已完成", "✓", "")` - 完成状态显示勾选标记

#### AND / OR - 逻辑与/或
```
AND(条件1, 条件2, ...)
OR(条件1, 条件2, ...)
```
**示例**：
- `AND({语文} >= 60, {数学} >= 60)` - 两科都及格
- `OR({状态} = "已完成", {状态} = "已取消")` - 已完成或已取消

#### NOT - 逻辑非
```
NOT(条件)
```
**示例**：
- `NOT({完成})` - 未完成

#### SWITCH - 多条件匹配
```
SWITCH(表达式, 值1, 结果1, 值2, 结果2, ..., 默认结果)
```
**示例**：
```
SWITCH({优先级},
  "高", "🔴",
  "中", "🟡",
  "低", "🟢",
  ""
)
```

#### IFS - 多条件判断
```
IFS(条件1, 结果1, 条件2, 结果2, ...)
```
**示例**：
```
IFS(
  {分数} >= 90, "优秀",
  {分数} >= 80, "良好",
  {分数} >= 60, "及格",
  {分数} < 60, "不及格"
)
```

### 查找引用函数

#### VLOOKUP - 垂直查找
```
VLOOKUP(查找值, 查找范围, 列序号, [精确匹配])
```
**示例**：
- `VLOOKUP({商品ID}, {商品表}, 3, TRUE)` - 查找商品价格

#### LOOKUP - 查找值
```
LOOKUP(查找值, 查找范围, 结果范围)
```
**示例**：
- `LOOKUP({等级}, {等级表}, {分数范围})` - 根据等级查找分数范围

### 关联表函数

#### COUNTALL - 计数
```
COUNTALL(关联字段)
```
**示例**：
- `COUNTALL({关联任务})` - 计算关联任务的数量

#### COUNTA - 非空计数
```
COUNTA(字段1, 字段2, ...)
```
**示例**：
- `COUNTA({任务1}, {任务2}, {任务3})` - 计算已填写的任务数

#### COUNTIF - 条件计数
```
COUNTIF(范围, 条件)
```
**示例**：
- `COUNTIF({状态}, "已完成")` - 计算已完成状态的数量

### 数据验证函数

#### ISBLANK - 是否为空
```
ISBLANK(值)
```
**示例**：
- `IF(ISBLANK({邮箱}), "请填写邮箱", "✓")` - 验证邮箱是否填写

#### ISERROR - 是否错误
```
ISERROR(值)
```
**示例**：
- `IF(ISERROR({价格}/{数量}), 0, {价格}/{数量})` - 避免除零错误

#### ERROR_TYPE - 错误类型
```
ERROR_TYPE(错误值)
```
**示例**：
- `ERROR_TYPE(A1)` - 返回错误类型编号

## 常见公式模式

### 1. 计算字段值
```javascript
// 简单计算
{单价} * {数量}

// 带条件计算
IF({数量} >= 10, {单价} * 0.9, {单价}) * {数量}

// 复杂计算
({单价} * {数量}) - ({折扣} * {单价} * {数量})
```

### 2. 文本拼接和格式化
```javascript
// 简单拼接
{姓名} & "（" & {部门} & "）"

// 条件拼接
IF({完成}, "✓ " & {任务名}, "○ " & {任务名})

// 复杂格式化
IF({性别} = "男",
  {姓} & "先生",
  {姓} & "女士"
) & "，" & {职位}
```

### 3. 日期计算
```javascript
// 计算工作日
DATEDIF({开始日期}, {结束日期}, "D")

// 计算剩余天数
DATETIME_DIFF({截止日期}, TODAY(), "D")

// 条件日期
IF({紧急}, DATEADD(TODAY(), 3, "D"), DATEADD(TODAY(), 7, "D"))
```

### 4. 状态判断
```javascript
// 简单状态
IF({完成}, "已完成", "未完成")

// 多级状态
IFS(
  {进度} = 1, "已完成",
  {进度} = 0.5, "进行中",
  {进度} = 0, "未开始"
)

// 颜色标记
SWITCH({优先级},
  "高", "🔴",
  "中", "🟡",
  "低", "🟢",
  ""
)
```

### 5. 数据验证
```javascript
// 必填验证
IF(ISBLANK({邮箱}), "❌ 邮箱必填", "✓")

// 格式验证
IF(FIND("@", {邮箱}) > 0, "✓", "❌ 邮箱格式错误")

// 范围验证
IF(AND({年龄} >= 18, {年龄} <= 60), "✓", "❌ 年龄不在范围内")
```

### 6. 关联表汇总
```javascript
// 计数关联记录
COUNTALL({关联任务})

// 汇总关联字段
SUM({关联订单.金额})

// 平均值
AVERAGE({关联任务.评分})

// 条件计数
COUNTIF({关联任务.状态}, "已完成")
```

## 复杂公式案例

### 案例1：计算任务剩余天数（考虑工作日）
```javascript
IF({状态} = "已完成",
  0,
  DATETIME_DIFF({截止日期}, TODAY(), "D")
)
```

### 案例2：客户价值评分系统
```javascript
// 基于多个因素计算客户价值
SUM(
  IF({成交金额} > 100000, 30, IF({成交金额} > 50000, 20, 10)) +
  IF({合作年限} >= 3, 20, IF({合作年限} >= 1, 10, 0)) +
  IF({续费次数} >= 3, 20, IF({续费次数} >= 1, 10, 0)) +
  IF({转介绍数} >= 5, 30, IF({转介绍数} >= 1, 15, 0))
)
```

### 案例3：库存预警系统
```javascript
IF({库存数量} <= 0,
  "缺货",
  IF({库存数量} <= {安全库存},
    "库存预警",
    "正常"
  )
)
```

### 案例4：员工绩效考核
```javascript
// 综合多个指标计算绩效得分
IFS(
  AND({KPI} >= 90, {考勤} >= 95, {满意度} >= 90), "优秀",
  AND({KPI} >= 80, {考勤} >= 90, {满意度} >= 80), "良好",
  AND({KPI} >= 60, {考勤} >= 80, {满意度} >= 60), "合格",
  TRUE, "待改进"
)
```

### 案例5：项目进度自动计算
```javascript
// 基于已完成任务数计算整体进度
IF(COUNTALL({关联任务}) > 0,
  ROUND(
    COUNTIF({关联任务.状态}, "已完成") / COUNTALL({关联任务}) * 100,
    0
  ) & "%",
  "0%"
)
```

### 案例6：合同到期提醒
```javascript
IF({到期日期} < TODAY(),
  "已过期 " & DATEDIF({到期日期}, TODAY(), "D") & " 天",
  IF(DATEDIF(TODAY(), {到期日期}, "D") <= 30,
    "即将到期 " & DATEDIF(TODAY(), {到期日期}, "D") & " 天",
    "正常"
  )
)
```

### 案例7：订单状态追踪
```javascript
SWITCH({状态},
  "待付款", "💰 " & {创建日期},
  "已付款", "📦 处理中",
  "已发货", "🚚 " & {快递单号},
  "已完成", "✅ " & {完成日期},
  "已取消", "❌ " & {取消原因},
  ""
)
```

### 案例8：加班工资计算
```javascript
// 平时加班1.5倍，周末加班2倍，节假日加班3倍
IF({加班日期类型} = "节假日",
  {小时数} * {时薪} * 3,
  IF({加班日期类型} = "周末",
    {小时数} * {时薪} * 2,
    {小时数} * {时薪} * 1.5
  )
)
```

## 公式调试技巧

### 1. 分步验证
- 将复杂公式拆分为多个简单公式
- 验证每一步的中间结果
- 确认无误后再组合

### 2. 错误处理
```javascript
// 避免除零错误
IF({数量} = 0, 0, {金额}/{数量})

// 避免空值错误
IF(ISBLANK({价格}), 0, {价格} * {数量})

// 使用ISERROR捕获错误
IF(ISERROR(A1/B1), 0, A1/B1)
```

### 3. 使用测试数据
- 准备各种边界情况的测试数据
- 验证公式的鲁棒性
- 测试最大值、最小值、空值、错误值等

### 4. 公式优化
- 避免重复计算，使用中间字段
- 简化逻辑，使用更直接的判断
- 合理使用查找函数减少IF嵌套

### 5. 性能考虑
- 避免在大量数据中使用复杂的嵌套公式
- 优先使用汇总字段而非复杂公式
- 合理使用缓存和预计算
