# 自动化规则配置

## 目录
- [概览](#概览)
- [自动化基础](#自动化基础)
- [触发器类型](#触发器类型)
- [条件设置](#条件设置)
- [动作类型](#动作类型)
- [常见自动化场景](#常见自动化场景)
- [最佳实践](#最佳实践)

## 概览
飞书多维表格自动化功能可以根据预设的条件自动执行操作，减少重复性工作，提升工作效率。合理配置自动化规则可以实现流程的自动化和标准化。

## 自动化基础

### 自动化三要素
1. **触发器（Trigger）**：什么时候执行自动化
2. **条件（Condition）**：满足什么条件才执行
3. **动作（Action）**：执行什么操作

### 工作流程
```
触发器（事件发生）
    ↓
条件判断（是否符合条件）
    ↓
执行动作（自动操作）
    ↓
结果反馈（成功/失败）
```

### 创建自动化
- 在表格右上角点击"自动化"
- 点击"新建自动化"
- 按向导配置触发器、条件、动作
- 保存并启用自动化

## 触发器类型

### 1. 记录创建时
- **说明**：当新增一条记录时触发
- **适用场景**：
  - 新建客户时自动创建跟进任务
  - 提交表单时自动通知相关人员
  - 新增订单时自动计算总价

- **示例**：
  ```
  触发器：记录创建时
  条件：{客户来源} = "线上"
  动作：发送消息给销售经理
  ```

### 2. 记录更新时
- **说明**：当记录被修改时触发
- **适用场景**：
  - 任务状态变更时通知相关人员
  - 关键字段修改时记录日志
  - 金额变更时重新计算

- **示例**：
  ```
  触发器：记录更新时
  条件：{状态} 变更为 "已完成"
  动作：发送通知给负责人
  ```

### 3. 特定字段变更
- **说明**：当指定字段的值发生变化时触发
- **适用场景**：
  - 优先级变更时提醒
  - 负责人变更时通知新旧负责人
  - 截止日期变更时调整计划

- **示例**：
  ```
  触发器：{截止日期} 字段变更
  条件：新值 < 今天的日期
  动作：发送紧急提醒
  ```

### 4. 定时触发
- **说明**：按照设定的时间周期触发
- **适用场景**：
  - 每日提醒待办任务
  - 每周发送项目进度报告
  - 每月统计数据汇总

- **示例**：
  ```
  触发器：每周一上午9点
  条件：{截止日期} 在本周
  动作：发送任务清单
  ```

### 5. 按钮触发
- **说明**：通过点击记录中的按钮触发
- **适用场景**：
  - 手动触发审批流程
  - 批量操作确认
  - 手动启动特定流程

- **示例**：
  ```
  触发器：点击"提交审批"按钮
  条件：{审批状态} = "待审批"
  动作：发送审批请求
  ```

## 条件设置

### 基础条件
- **字段值比较**：等于、不等于、大于、小于、包含、不包含等
- **多条件组合**：AND（所有条件）、OR（任一条件）
- **字段类型支持**：文本、数字、日期、单选、多选等

### 常见条件示例

#### 数值比较
```
{库存数量} <= {安全库存}  // 库存不足
{金额} > 10000            // 大额订单
{评分} >= 4.5             // 高评分
```

#### 日期比较
```
{截止日期} < TODAY()            // 已过期
{截止日期} <= TODAY() + 3       // 3天内到期
{创建日期} >= DATEADD(TODAY(), -7, "D")  // 本周创建
```

#### 文本匹配
```
{状态} = "已完成"                         // 等于
FIND("紧急", {标题}) > 0                  // 包含
LEN({描述}) > 100                         // 文本长度
```

#### 单选/多选
```
IN({优先级}, ["高", "紧急"])              // 包含在选项中
{状态} != "已取消"                        // 不等于
CONTAINS({标签}, "重要")                  // 多选包含
```

#### 关联表
```
COUNTALL({关联任务}) > 0                  // 有关联任务
{关联客户.等级} = "VIP"                   // 关联表字段
```

### 条件组
- 支持多组条件，每组之间可以设置AND/OR关系
- 每组内部支持多个条件组合
- 可以嵌套多层级条件

#### 复杂条件示例
```
(条件组1 OR 条件组2) AND 条件组3

条件组1: {状态} = "待处理" AND {优先级} = "高"
条件组2: {截止日期} < DATEADD(TODAY(), 1, "D")
条件组3: {负责人} != ""
```

## 动作类型

### 1. 更新字段
- **说明**：修改当前记录的字段值
- **支持字段类型**：大部分字段类型
- **常见操作**：
  - 更新状态
  - 设置负责人
  - 记录操作时间
  - 计算结果

- **示例**：
  ```
  动作：更新字段
  设置：{状态} = "已通知"
  设置：{通知时间} = NOW()
  ```

### 2. 创建记录
- **说明**：在指定表中创建新记录
- **适用场景**：
  - 新增任务
  - 创建跟进记录
  - 生成报表

- **示例**：
  ```
  动作：在"任务表"中创建记录
  设置：{任务名称} = {标题}
  设置：{负责人} = {负责人}
  设置：{截止日期} = {截止日期}
  ```

### 3. 发送消息
- **说明**：向指定人员发送飞书消息
- **消息类型**：
  - 文本消息
  - 富文本消息
  - 卡片消息

- **示例**：
  ```
  动作：发送消息
  接收人：{负责人}
  内容：您的任务"{任务名称}"将于3天内到期，请及时处理。
  ```

### 4. 发送邮件
- **说明**：向指定邮箱发送邮件
- **适用场景**：
  - 客户通知
  - 报告发送
  - 提醒邮件

- **示例**：
  ```
  动作：发送邮件
  收件人：{客户邮箱}
  主题：您的订单已发货
  内容：尊敬的客户，您的订单{订单号}已发货...
  ```

### 5. 添加评论
- **说明**：在记录中添加评论
- **适用场景**：
  - 记录操作日志
  - 团队沟通
  - 备注说明

- **示例**：
  ```
  动作：添加评论
  内容：系统自动提醒：任务即将到期
  ```

### 6. 修改关联记录
- **说明**：更新关联表中的记录
- **适用场景**：
  - 更新关联任务状态
  - 同步关联信息
  - 级联更新

- **示例**：
  ```
  动作：修改关联记录
  在：{关联任务}
  设置：{状态} = "已取消"
  ```

### 7. 删除记录
- **说明**：删除指定的记录
- **适用场景**：
  - 清理过期数据
  - 删除重复记录
  - 归档处理

- **示例**：
  ```
  动作：删除记录
  条件：{状态} = "已取消" AND {删除时间} > 30天前
  ```

### 8. 发起审批
- **说明**：创建飞书审批流程
- **适用场景**：
  - 费用报销
  - 采购申请
  - 请假审批

- **示例**：
  ```
  动作：发起审批
  审批模板：费用报销审批
  字段映射：{金额} → {申请金额}
  ```

### 9. 调用Webhook
- **说明**：向外部系统发送HTTP请求
- **适用场景**：
  - 与第三方系统集成
  - 调用外部API
  - 数据同步

- **示例**：
  ```
  动作：调用Webhook
  URL: https://api.example.com/create
  Method: POST
  Body: { "title": "{任务名称}", "status": "{状态}" }
  ```

### 10. 延时动作
- **说明**：延迟一定时间后执行动作
- **适用场景**：
  - 提前提醒
  - 延期执行
  - 定时触发

- **示例**：
  ```
  动作：等待
  延时：1天

  动作：发送消息
  内容：任务已延期1天，请及时处理
  ```

## 常见自动化场景

### 场景1：任务提醒系统
```
触发器：定时触发（每天上午9点）
条件：{截止日期} 在今天，AND {状态} != "已完成"
动作：发送消息给{负责人}
内容：您的任务"{任务名称}"今天到期，请及时处理。
```

### 场景2：客户跟进自动化
```
触发器：记录创建时
条件：{客户类型} = "新客户"
动作：
  1. 在"跟进记录表"创建记录
     {客户} = 当前记录
     {跟进类型} = "首次联系"
     {跟进时间} = NOW()
  2. 发送消息给销售经理
     新客户"{客户名称}"已添加，请分配负责人。
```

### 场景3：库存预警
```
触发器：记录更新时
条件：{库存数量} <= {安全库存}
动作：
  1. 更新字段 {库存状态} = "库存不足"
  2. 发送消息给采购部门
     商品"{商品名称}"库存不足，当前库存{库存数量}，安全库存{安全库存}，请及时补货。
```

### 场景4：项目进度追踪
```
触发器：记录更新时
条件：{关联任务.状态} 全部为"已完成"
动作：
  1. 更新字段 {项目状态} = "已完成"
  2. 发送消息给项目经理
     项目"{项目名称}"已全部完成。
```

### 场景5：订单处理流程
```
触发器：记录创建时（订单表）
动作：
  1. 在"任务表"创建记录（生成处理任务）
     {任务名称} = "处理订单{订单号}"
     {任务类型} = "订单处理"
     {截止日期} = DATEADD(TODAY(), 2, "D")

  2. 更新字段 {订单状态} = "处理中"

触发器：记录更新时（任务表）
条件：{任务状态} = "已完成" AND {任务类型} = "订单处理"
动作：
  1. 修改关联记录（更新订单）
     {订单状态} = "已完成"
     {完成时间} = NOW()
```

### 场景6：合同到期提醒
```
触发器：定时触发（每天上午10点）
条件：{到期日期} 在未来30天内，AND {续签状态} = "未处理"
动作：
  1. 更新字段 {提醒状态} = "已提醒"
  2. 发送消息给{负责人}
     合同"{合同名称}"将于{到期日期}到期，距离今天还有{DATEDIF(TODAY(), {到期日期}, "D")}天，请及时续签。
```

### 场景7：考勤异常提醒
```
触发器：记录创建时（打卡记录）
条件：{打卡时间} > {规定上班时间}
动作：
  1. 在"异常记录表"创建记录
     {员工} = {员工}
     {异常类型} = "迟到"
     {迟到分钟数} = DATEDIF({规定上班时间}, {打卡时间}, "M")

  2. 发送消息给{员工}和{部门经理}
     {员工}今天迟到{迟到分钟数}分钟，请注意考勤时间。
```

### 场景8：销售漏斗自动化
```
触发器：记录更新时（客户表）
条件：{销售阶段} 从"意向客户"变更为"成交客户"
动作：
  1. 在"成交记录表"创建记录
     {客户} = 当前记录
     {成交金额} = {预计成交金额}
     {成交时间} = NOW()

  2. 发送消息给销售经理
     恭喜！客户"{客户名称}"已成交，成交金额{成交金额}。

  3. 更新字段 {成交时间} = NOW()
```

## 最佳实践

### 1. 命名规范
- 自动化规则名称应清晰描述其功能
- 示例："库存预警"、"任务到期提醒"、"客户跟进自动化"

### 2. 条件设计
- 条件要具体明确，避免过于宽泛
- 考虑边界情况和异常数据
- 使用合理的运算符

### 3. 动作顺序
- 多个动作按序执行，注意动作之间的依赖关系
- 关键操作放在前面
- 日志记录放在最后

### 4. 错误处理
- 为关键自动化设置失败通知
- 记录自动化执行日志
- 定期检查自动化运行状态

### 5. 性能优化
- 避免循环触发（A触发B，B又触发A）
- 合并相似的自动化规则
- 减少不必要的自动化执行

### 6. 测试验证
- 新建自动化前先进行测试
- 准备各种测试数据（边界情况）
- 验证自动化执行结果是否符合预期

### 7. 文档记录
- 为每个自动化规则编写说明文档
- 记录触发条件、动作逻辑、注意事项
- 方便后续维护和交接

### 8. 权限控制
- 控制自动化的可见性
- 限制自动化规则的编辑权限
- 确保自动化操作符合数据安全规范

### 9. 监控告警
- 定期查看自动化执行日志
- 设置自动化失败告警
- 及时处理异常情况

### 10. 版本管理
- 重要修改前备份当前配置
- 记录变更历史
- 出现问题时可以快速回滚
